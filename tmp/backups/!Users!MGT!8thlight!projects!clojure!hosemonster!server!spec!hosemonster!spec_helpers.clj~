(ns hosemonster.spec-helpers
  (:use
    [speclj.core]
    [joodo.spec-helpers.controller :only [do-get do-post]]
    [hosemonster.accounts.account :only [account]]
    [hosemonster.util.model :only [validate]]
    [hosemonster.users.user :only [user]]
    [hosemonster.accounts.account :only [account]]
    [hosemonster.job-sites.job-site :only [job-site]]
    [hosemonster.fire-pumps.fire-pump :only [fire-pump]]
    [hosemonster.work-orders.work-order :only [work-order]]
    [hosemonster.customers.customer :only [customer]]
    [hosemonster.token :only [build-token]]
    [hyperion.core :only [*ds*]]
    [hyperion.memory :only [new-memory-datastore]]))

(defn logged-in-get [user resource & extras]
  (let [token (build-token user)]
    (apply do-get resource :cookies {:token {:value token}} extras)))

(defn logged-in-post [user resource & extras]
  (let [token (build-token user)]
    (apply do-post resource :cookies {:token {:value token}} extras)))

(def valid-account (account :name "Acme, Inc."))

(defn valid-user [account-key]
  (user :email "joe@acme.com" :password "foo" :account-key account-key))

(defn valid-customer [account-key]
  (customer :account-key account-key :addr-line-1 "foo st." :zipcode "12345" :state "IL" :city "Chicago" :country "US" :first-name "Joe" :last-name "Smith" :phone-number "3096451393" :email "snap.into@slim.jim" :company-name "sears"))

(defn valid-job-site [customer-key]
  {:kind "job-site" :customer-key customer-key :addr-line-1 "thing" :zipcode "12345" :state "IL" :city "Chicago" :country "US" :building-name "Sears" :first-name "Myles" :last-name "Myegyesi" :phone-number "3096451393" :email "a@b.com"})

(defn valid-fire-pump [job-site-key]
  {:kind "fire-pump" :job-site-key job-site-key})

(defn valid-work-order [fire-pump-key]
  {:kind "work-order" :fire-pump-key fire-pump-key :type "some-type" :date "here"})

(defn invalid-customer [account-key]
  (customer :account-key account-key))

(def invalid-customer-errors (validate (invalid-customer nil)))

(def valid-job-site-fields { :building-name "Acme Tower"
                             :building-owner "Acme"
                             :addr-line-1 "123 Fake St."
                             :addr-line-2 "Unit 1"
                             :city "Winning"
                             :state "Illinois"
                             :zipcode "60612"
                             :country "United States"
                             :first-name "Joe"
                             :last-name "Blow"
                             :phone-number "3096451393"
                             :fax-number "3096451393"
                             :email "site.blow@acme.com"
                             :notes "really likes gum"})

(defn get-valid-job-site [customer-key]
  (job-site valid-job-site-fields :customer-key customer-key))

(def valid-fire-pump-fields {:pump-shaft-type "vertical"
                             :pump-manufacturer "PumpItUp"
                             :pump-approved? true
                             :pump-serial-number "X1234567890"
                             :pump-model "P9000"
                             :pump-rated-gpm 101
                             :driver-engine-type "diesel engine"
                             :pump-rated-head-psi 202
                             :pump-rated-head-churn-psi 203
                             :pump-rated-head-overload-psi 204
                             :pump-rated-rpm 303
                             :pump-suction-from "city water"
                             :pump-tank-size "500G"
                             :pump-tank-height "6ft"
                             :vertical-pump-guage-to-water-distance-static "5ft"
                             :vertical-pump-guage-to-water-distance-pumping "4ft"
                             :right-angle-drive-manufacturer "PIU"
                             :right-angle-drive-model "P800"
                             :right-angle-drive-serial-number "P4321"
                             :right-angle-drive-performance "smooth"
                             :right-angle-drive-approved? true
                             :driver-manufacturer "DIU"
                             :driver-approved? true
                             :driver-serial-number "D1234"
                             :driver-model "D70"
                             :driver-rated-hp "350"
                             :driver-rated-rpm "530"
                             :driver-electric-motor? true
                             :driver-rated-voltage "110"
                             :driver-operating-voltage "220"
                             :driver-rated-fl-amps "50"
                             :driver-amps-at-150-pct "60"
                             :driver-phase "moon"
                             :driver-cycles "10"
                             :driver-service-factor "X"
                             :driver-press-type "built-in"
                             :controller-manufacturer "CIU"
                             :controller-approved? true
                             :controller-start-psi 404
                             :controller-stop-psi 505
                             :controller-start-psi-type "manual"
                             :controller-stop-psi-type "manual"
                             :controller-serial-number "C0987"
                             :controller-model "C6"
                             :controller-is-jockey-pump? true
                             :controller-jockey-pump-on-psi 606
                             :controller-jockey-pump-off-psi 707})

(defn get-valid-fire-pump [job-site-key]
  (fire-pump valid-fire-pump-fields :job-site-key job-site-key))

(def valid-work-order-fields {:type "Normal"
                              :date "1/1/2012"
                              :notes "Howdy"
                              :fire-department-attendee "Fred"
                              :building-rep-attendee "Bill"
                              :sprinkler-contractor-attendee "Stan"
                              :pump-manufacturer-attendee "Pete"})

(defn get-valid-work-order [fire-pump-key]
  (work-order valid-work-order-fields :fire-pump-key fire-pump-key))


(defmacro should-render-not-found [response rendered-context rendered-template]
  `(do
     (should= 404 (:status ~response))
     (should= "hosemonster" (:template-root ~rendered-context))
     (should= 'hosemonster.util.view-helpers (:ns ~rendered-context))
     (should= "util/layout" (:layout ~rendered-context))
     (should= "util/not_found" ~rendered-template)))

(defmacro should-redirect-to-after-post [response location]
  `(do
     (should= 303 (:status ~response))
     (should= ~location ((:headers ~response) "Location"))))

(defmacro should-have-cookie [response name value]
  `(should= ~value (-> ~response :cookies ~name :value)))

(defmacro with-memory-datastore []
  `(around [it#]
    (binding [*ds* (new-memory-datastore)]
      (it#))))
