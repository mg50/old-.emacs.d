(ns hosemonster.job-sites.job-sites-controller
  (:use
    [hyperion.core :only [find-by-key find-by-kind]]
    [compojure.core :only [defroutes routes GET POST context]]
    [joodo.views :only [render-template]]
    [hosemonster.job-sites.job-site :only [job-site]]
    [hosemonster.sessions.util :only [with-user-required *user*]]
    [hosemonster.crud.crud-interactor]
    [hosemonster.server-setup :only [crud-interactor]]
    [hosemonster.util.controller :only [require-valid-signin]]))

(defn save-job-site [params]
  (let [job-site-to-save (job-site (assoc (:job-site params) :key (:job-site-key params)))]
    (save-model crud-interactor job-site-to-save)))

(defroutes job-sites-controller
  (with-user-required
    (context "/job-sites" []
      (POST "/" {params :params} (save-job-site params))
      (GET "/new" [] (render-template "job_sites/form"))
      (GET "/:job-site-key" [job-site-key] (view-model crud-interactor job-site-key))
      (POST "/:job-site-key" {params :params} (save-job-site params))
      (GET "/:job-site-key/delete" [job-site-key] (delete-model crud-interactor job-site-key)))))
